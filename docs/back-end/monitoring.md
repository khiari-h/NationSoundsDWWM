# Monitoring et Alerting

## Introduction

Ce document d√©taille la strat√©gie de monitoring et d'alerting mise en place pour l'application NationSounds. L'objectif est de garantir une haute disponibilit√© du service, d'identifier rapidement les probl√®mes potentiels et de permettre une r√©solution proactive des incidents avant qu'ils n'affectent les utilisateurs.

## Architecture de Monitoring

### Vue d'ensemble

Notre architecture de monitoring repose sur plusieurs niveaux de surveillance :

1. **Monitoring syst√®me** : Surveillance des ressources serveur (CPU, m√©moire, disque, r√©seau)
2. **Monitoring applicatif** : Surveillance des performances et comportements de l'application
3. **Monitoring utilisateur** : Mesure de l'exp√©rience utilisateur r√©elle
4. **Monitoring de s√©curit√©** : D√©tection des menaces et comportements suspects

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Collecte de Donn√©es ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Traitement et   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Visualisation &  ‚îÇ
‚îÇ                     ‚îÇ     ‚îÇ  Agr√©gation      ‚îÇ     ‚îÇ  Alerting         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚ñ≤                           ‚ñ≤                         ‚îÇ
         ‚îÇ                           ‚îÇ                         ‚îÇ
         ‚îÇ                           ‚îÇ                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Agents & Exporters  ‚îÇ     ‚îÇ   Stockage des   ‚îÇ     ‚îÇ R√©ponse & Rem√®de  ‚îÇ
‚îÇ                     ‚îÇ     ‚îÇ   M√©triques      ‚îÇ     ‚îÇ                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Outils de Monitoring

#### Sentry
- **Objectif** : Monitoring d'erreurs et d'exceptions dans l'application
- **Composants surveill√©s** : Backend (Laravel), Frontend (React)
- **M√©triques cl√©s** : Taux d'erreurs, temps de r√©ponse, transactions

#### New Relic
- **Objectif** : Surveillance des performances applicatives (APM)
- **Composants surveill√©s** : Backend, Base de donn√©es, API
- **M√©triques cl√©s** : Latence des requ√™tes, d√©bit, utilisation des ressources, tra√ßage distribu√©

#### Uptime Robot
- **Objectif** : Surveillance de la disponibilit√© et temps de r√©ponse externe
- **Composants surveill√©s** : Points de terminaison API, site web frontend
- **M√©triques cl√©s** : Disponibilit√© (uptime), temps de r√©ponse, codes de statut HTTP

#### Prometheus & Grafana (optionnel)
- **Objectif** : Stockage de m√©triques √† long terme et visualisations personnalis√©es
- **Composants surveill√©s** : Infrastructure, application, bases de donn√©es
- **M√©triques cl√©s** : Personnalisables selon les besoins sp√©cifiques du projet

## Configuration des Outils

### Sentry

#### Installation
```bash
# Installation du SDK Laravel
composer require sentry/sentry-laravel

# Publication de la configuration
php artisan sentry:publish --dsn=https://your-sentry-dsn@sentry.io/project-id
```

#### Configuration
Dans le fichier `.env` :
```
SENTRY_LARAVEL_DSN=https://your-sentry-dsn@sentry.io/project-id
SENTRY_TRACES_SAMPLE_RATE=1.0
SENTRY_ENVIRONMENT=production
```

Dans le fichier `app/Exceptions/Handler.php` :
```php
public function report(Throwable $exception)
{
    if (app()->bound('sentry') && $this->shouldReport($exception)) {
        app('sentry')->captureException($exception);
    }

    parent::report($exception);
}
```

Configuration Frontend (React) :
```javascript
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: "https://your-sentry-dsn@sentry.io/project-id",
  integrations: [new Sentry.BrowserTracing()],
  tracesSampleRate: 1.0,
  environment: 'production',
});
```

### New Relic

#### Installation
```bash
# T√©l√©chargement et installation de l'agent
curl -Ls https://download.newrelic.com/install/newrelic-cli/scripts/install.sh | bash

# Installation de APM
NEW_RELIC_API_KEY=<YOUR_API_KEY> NEW_RELIC_ACCOUNT_ID=<YOUR_ACCOUNT_ID> \
  /usr/local/bin/newrelic install -n php-agent-installer
```

#### Configuration
Dans le fichier `newrelic.ini` :
```ini
newrelic.appname = "NationSounds"
newrelic.license = "your-license-key"
newrelic.framework = "laravel"
newrelic.framework.drupal.modules = true
newrelic.browser_monitoring.auto_instrument = true
newrelic.transaction_tracer.record_sql = "obfuscated"
```

### Uptime Robot

#### Configuration
1. Cr√©er un compte sur [Uptime Robot](https://uptimerobot.com/)
2. Ajouter les moniteurs suivants :
   - Monitor Type: HTTP(s)
   - URL: https://api.nationsounds.com/health
   - Monitoring Interval: 5 minutes
   - Alert Contact: √©quipe technique (email et Slack)

R√©p√©ter pour les endpoints importants :
- Site principal: https://nationsounds.com
- API: https://api.nationsounds.com/api/v1/status
- Backoffice: https://admin.nationsounds.com

## Strat√©gie d'Alerting

### Niveaux d'Alerte

| Niveau | Description | D√©lai de r√©ponse | Canal de notification |
|--------|-------------|------------------|----------------------|
| **Critique** | Incident affectant tous les utilisateurs | Imm√©diat (24/7) | SMS, Appel, Slack, Email |
| **√âlev√©** | Incident affectant une fonctionnalit√© majeure | < 30 minutes | Slack, Email |
| **Moyen** | Performance d√©grad√©e | < 2 heures | Slack, Email |
| **Faible** | Anomalie mineure | Jour ouvr√© suivant | Email |

### Matrice d'Alerte

| M√©trique | Seuil Critique | Seuil √âlev√© | Seuil Moyen | Seuil Faible |
|----------|----------------|-------------|-------------|--------------|
| Uptime | < 99.5% | < 99.9% | < 99.95% | < 99.99% |
| Temps de r√©ponse API | > 1000ms | > 500ms | > 300ms | > 200ms |
| Taux d'erreur | > 5% | > 2% | > 1% | > 0.5% |
| Utilisation CPU | > 90% | > 80% | > 70% | > 60% |
| Utilisation m√©moire | > 90% | > 80% | > 70% | > 60% |
| Espace disque disponible | < 5% | < 10% | < 20% | < 30% |

## Scripts d'Alerte

### Script de monitoring sant√© API

```bash
#!/bin/bash
# health_check.sh - V√©rifie la sant√© de l'API et envoie des alertes

API_URL="https://api.nationsounds.com/health"
SLACK_WEBHOOK="https://hooks.slack.com/services/XXX/YYY/ZZZ"

response=$(curl -s -o /dev/null -w "%{http_code}" $API_URL)

if [ $response -ne 200 ]; then
    # Enregistrer dans les logs
    echo "$(date) - L'API est indisponible (code: $response)" >> /var/log/nationsounds/health.log
    
    # Envoyer une alerte Slack
    curl -X POST -H 'Content-type: application/json' --data '{
        "text": "üö® ALERTE: L'API NationSounds est indisponible (code: '"$response"')!"
    }' $SLACK_WEBHOOK
    
    # Envoyer un email
    echo "L'API NationSounds est indisponible (code: $response)!" | mail -s "ALERTE: API NationSounds indisponible" tech-alert@nationsounds.com
fi
```

### Script d'alerte utilisation ressources

```bash
#!/bin/bash
# resource_monitor.sh - Surveille les ressources serveur

SLACK_WEBHOOK="https://hooks.slack.com/services/XXX/YYY/ZZZ"
LOG_FILE="/var/log/nationsounds/resource.log"

# V√©rifier l'utilisation CPU
cpu_usage=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
cpu_threshold=80

# V√©rifier l'utilisation m√©moire
mem_usage=$(free | grep Mem | awk '{print $3/$2 * 100.0}')
mem_threshold=80

# V√©rifier l'espace disque
disk_usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
disk_threshold=80

# Logger les valeurs
echo "$(date) - CPU: $cpu_usage%, MEM: $mem_usage%, DISK: $disk_usage%" >> $LOG_FILE

# V√©rifier les seuils et alerter si n√©cessaire
if (( $(echo "$cpu_usage > $cpu_threshold" | bc -l) )); then
    curl -X POST -H 'Content-type: application/json' --data '{
        "text": "üö® ALERTE: Utilisation CPU √©lev√©e: '"$cpu_usage"'%"
    }' $SLACK_WEBHOOK
fi

if (( $(echo "$mem_usage > $mem_threshold" | bc -l) )); then
    curl -X POST -H 'Content-type: application/json' --data '{
        "text": "üö® ALERTE: Utilisation m√©moire √©lev√©e: '"$mem_usage"'%"
    }' $SLACK_WEBHOOK
fi

if (( $(echo "$disk_usage > $disk_threshold" | bc -l) )); then
    curl -X POST -H 'Content-type: application/json' --data '{
        "text": "üö® ALERTE: Espace disque faible: '"$disk_usage"'%"
    }' $SLACK_WEBHOOK
fi
```

## Tableaux de Bord (Dashboards)

### Dashboard Principal
Un dashboard consolid√© accessible √† l'√©quipe technique pr√©sentant :
- Disponibilit√© du service en temps r√©el
- Temps de r√©ponse moyen des API
- Taux d'erreur global
- Utilisation des ressources serveur
- Nombre de sessions utilisateurs actives

### Dashboard Performance
Destin√© √† l'√©quipe dev/DevOps pour l'optimisation :
- Temps de r√©ponse par endpoint API
- Temps d'ex√©cution des requ√™tes SQL les plus lentes
- Utilisation du cache et taux de hit/miss
- Performance de chargement frontend

### Dashboard M√©tier
Pour les parties prenantes non techniques :
- Nombre d'utilisateurs actifs
- Taux de conversion
- Temps de session moyen
- Fonctionnalit√©s les plus utilis√©es

## Proc√©dures d'Intervention

### Processus d'Escalade

1. **Niveau 1** : Alerte re√ßue par l'√©quipe support technique
   - Analyse initiale et r√©solution si possible
   - Escalade au niveau 2 si non r√©solu en 15 minutes

2. **Niveau 2** : Prise en charge par l'√©quipe d√©veloppement
   - Analyse approfondie et application des correctifs
   - Escalade au niveau 3 si non r√©solu en 30 minutes

3. **Niveau 3** : Intervention de l'architecte syst√®me et du responsable technique
   - Mobilisation de ressources suppl√©mentaires si n√©cessaire
   - Communication aux parties prenantes

### Runbook d'Intervention

#### Indisponibilit√© API
1. V√©rifier l'√©tat des serveurs d'application
2. Contr√¥ler les logs d'erreur r√©cents
3. V√©rifier la connexion √† la base de donn√©es
4. Red√©marrer les services web si n√©cessaire
5. V√©rifier les ressources syst√®me (CPU, m√©moire, disque)
6. Basculer sur l'infrastructure de secours si disponible

#### Performance D√©grad√©e
1. Identifier les requ√™tes lentes dans les logs
2. V√©rifier les pics d'utilisation des ressources
3. Analyser les m√©triques Sentry/New Relic pour les goulots d'√©tranglement
4. Optimiser les requ√™tes probl√©matiques
5. Augmenter temporairement les ressources si n√©cessaire

#### Erreurs Applicatives
1. Analyser les erreurs dans Sentry
2. Reproduire le probl√®me en environnement de test
3. Appliquer un correctif temporaire si possible
4. D√©velopper et d√©ployer un correctif permanent
5. V√©rifier la r√©solution √† l'aide des m√©triques

## Maintenance et Am√©lioration Continue

### Revue P√©riodique
- Analyse mensuelle des performances et incidents
- Ajustement des seuils d'alerte selon les r√©sultats
- Mise √† jour des runbooks et proc√©dures

### Tests de Charge R√©guliers
- Simulation trimestrielle de pics de trafic
- V√©rification de la r√©silience du syst√®me
- Identification proactive des points faibles

### Cycle d'Am√©lioration
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Collecter   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Analyser    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Impl√©menter  ‚îÇ
‚îÇ  les donn√©es  ‚îÇ     ‚îÇ  les donn√©es  ‚îÇ     ‚îÇdes am√©liorations‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚ñ≤                                           ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Conclusion

Cette strat√©gie de monitoring et d'alerting vise √† garantir une exp√©rience utilisateur optimale pour l'application NationSounds, en permettant une d√©tection rapide et une r√©solution efficace des probl√®mes. La combinaison d'outils sp√©cialis√©s, de seuils d'alerte bien d√©finis et de proc√©dures d'intervention structur√©es assure la stabilit√© et la performance de la plateforme.